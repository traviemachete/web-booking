<!DOCTYPE html>
<html lang="th">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Custom Stylesheet -->
  <?!= include('Stylesheet') ?>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">

  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>

<body>
  <!-- Sidebar Navigation -->
  <nav class="sidebar">
    <h5>üè¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h5>
    <a href="#" onclick="loadView('calendar'); return false;" class="active" id="nav-calendar">
      üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
    </a>
    <a href="#" onclick="loadView('form'); return false;" id="nav-form">
      üìù ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
    </a>
    <a href="#" onclick="loadView('list'); return false;" id="nav-list">
      üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
    </a>
  </nav>

  <!-- Main Content Area -->
  <main class="main">
    <div id="mainContent">
      <!-- Dynamic content will be loaded here -->
      <div class="loading-placeholder">
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
          <h3>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h3>
          <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
        </div>
      </div>
    </div>
  </main>

  <!-- External Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Custom JavaScript -->
  <?!= include('JavaScript') ?>

  <script>
    // Initialize app when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Initializing booking system...');
      
      // Initialize theme
      initializeTheme();
      
      // Load default view after a short delay
      setTimeout(() => {
        loadView('calendar');
      }, 500);
    });

    // Theme management
    function initializeTheme() {
      const savedTheme = localStorage.getItem("booking-theme") || "light";
      document.documentElement.setAttribute("data-theme", savedTheme);
      console.log('üé® Theme initialized:', savedTheme);
    }

    function toggleTheme() {
      const headerToggle = document.getElementById("themeToggleHeader");
      
      let newTheme;
      if (headerToggle && headerToggle.checked !== undefined) {
        newTheme = headerToggle.checked ? "dark" : "light";
      } else {
        const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
        newTheme = currentTheme === "dark" ? "light" : "dark";
      }
      
      document.documentElement.setAttribute("data-theme", newTheme);
      localStorage.setItem("booking-theme", newTheme);
      
      // Sync toggle
      if (headerToggle) headerToggle.checked = newTheme === "dark";
      
      console.log('üé® Theme changed to:', newTheme);
    }

    // Navigation helpers
    function setActiveNav(viewName) {
      // Remove active class from all nav items
      document.querySelectorAll('.sidebar a').forEach(link => {
        link.classList.remove('active');
      });
      
      // Add active class to current nav item
      const activeNav = document.getElementById(`nav-${viewName}`);
      if (activeNav) {
        activeNav.classList.add('active');
      }
      
      console.log('üìç Navigation set to:', viewName);
    }

    // Load view function
    function loadView(viewName, forceRefresh = false) {
      console.log('üìÑ Loading view:', viewName);
      
      const mainContent = document.getElementById('mainContent');
      if (!mainContent) {
        console.error('‚ùå Main content element not found');
        return;
      }

      // Update navigation
      setActiveNav(viewName);
      
      // Show loading state
      if (!forceRefresh) {
        mainContent.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
            <h3>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h3>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
          </div>
        `;
      }

      // View mapping
      const viewMap = {
        calendar: 'CalendarView',
        form: 'Form',
        list: 'TodayList',
        login: 'Login'
      };

      const templateName = viewMap[viewName] || 'CalendarView';
      
      // Load from Google Apps Script only
      if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.include) {
        google.script.run
          .withSuccessHandler(function(html) {
            mainContent.innerHTML = html;
            handleViewLoaded(viewName);
            console.log('‚úÖ View loaded successfully:', viewName);
          })
          .withFailureHandler(function(error) {
            console.error('‚ùå Failed to load view from server:', error);
            mainContent.innerHTML = `
              <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <h3>‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                <button onclick="loadView('${viewName}')" style="margin-top: 16px; padding: 8px 16px; background: var(--google-blue); color: white; border: none; border-radius: 4px; cursor: pointer;">
                  ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                </button>
              </div>
            `;
          })
          .include(templateName);
      } else {
        // Show error when Google Apps Script is not available
        console.error('‚ùå Google Apps Script not available');
        mainContent.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
            <h3>‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</h3>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
          </div>
        `;
      }
    }

    // Handle post-load actions
    function handleViewLoaded(viewName) {
      if (viewName === 'calendar') {
        setTimeout(() => {
          // Load events from Google Apps Script
          if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler(function(events) {
                if (typeof renderCalendar === 'function') {
                  renderCalendar(events);
                } else {
                  console.error('‚ùå renderCalendar function not found');
                }
              })
              .withFailureHandler(function(error) {
                console.error('‚ùå Failed to load events:', error);
                const calendarEl = document.getElementById('calendar');
                if (calendarEl) {
                  calendarEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                      <h3>‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</h3>
                      <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Apps Script</p>
                      <button onclick="loadView('calendar', true)" style="margin-top: 16px; padding: 8px 16px; background: var(--google-blue); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                      </button>
                    </div>
                  `;
                }
              })
              .listEvents();
          } else {
            console.error('‚ùå Google Apps Script not available for loading events');
          }
        }, 200);
      }
      
      // Sync theme toggle in header if exists
      const headerToggle = document.getElementById('themeToggleHeader');
      if (headerToggle) {
        const savedTheme = localStorage.getItem("booking-theme") || "light";
        headerToggle.checked = savedTheme === "dark";
      }
    }

    // Refresh calendar - load from server
    function refreshCalendar() {
      console.log('üîÑ Refreshing calendar from server...');
      
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(events) {
            if (typeof renderCalendar === 'function') {
              renderCalendar(events);
              console.log('‚úÖ Calendar refreshed successfully');
            }
          })
          .withFailureHandler(function(error) {
            console.error('‚ùå Failed to refresh calendar:', error);
            if (typeof Swal !== 'undefined') {
              Swal.fire({
                icon: 'error',
                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'
              });
            }
          })
          .listEvents();
      } else {
        console.error('‚ùå Google Apps Script not available');
      }
    }

    // Global error handler
    window.addEventListener('error', function(e) {
      console.error('üí• Global error:', e.error);
    });

    console.log('üìù Booking system script loaded');
  </script>
</body>
</html>
