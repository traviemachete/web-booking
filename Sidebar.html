<!-- Sidebar.html (Google Style, Connected to main layout) -->
<div class="sidebar">
  <h5>Meeting Room</h5>
  <div class="user-info" id="userInfo">
    <!-- Filled by renderUserBox() -->
  </div>
  <ul class="menu"></ul>
</div>

<script>
function renderUserBox(){
  google.script.run.withSuccessHandler(function(user){
    const userBox = document.getElementById('userInfo');
    const menu = document.querySelector('.menu');
    if(!userBox || !menu) return;

    // Clear
    userBox.innerHTML = '';
    menu.innerHTML = '';

    if(user){ // Logged in
      userBox.innerHTML = `
        <p style="text-align:center">👤 <strong>${user.name}</strong></p>
        <div style="text-align:center">
          <button class="btn btn-primary" onclick="logout()">🚪 ออกจากระบบ</button>
        </div>
      `;
      menu.insertAdjacentHTML('beforeend',`
        <li><a href="#" onclick="loadView('calendar')">📅 ปฏิทิน</a></li>
        <li><a href="#" onclick="ensureAuth(()=>loadView('form'))">📝 จองห้อง</a></li>
        <li><a href="#" onclick="loadView('today')">📌 รายการวันนี้</a></li>
        <li><a href="#" onclick="loadView('mybookings')">📋 รายการของฉัน</a></li>
      `);
      if(user.role === 'admin'){
        menu.insertAdjacentHTML('beforeend',`
          <li><a href="#" onclick="loadView('admin')">🔧 จัดการระบบ</a></li>
        `);
      }
    } else { // Guest
      userBox.innerHTML = `
        <p style="text-align:center"><strong>ยังไม่ได้เข้าสู่ระบบ</strong></p>
        <div style="text-align:center">
          <button class="btn btn-primary" onclick="loadView('login')">🔑 เข้าสู่ระบบ</button>
        </div>
      `;
      menu.insertAdjacentHTML('beforeend',`
        <li><a href="#" onclick="loadView('calendar')">📅 ปฏิทิน</a></li>
      `);
    }
  }).getSessionUser();
}

function logout(){
  google.script.run.withSuccessHandler(()=>{
    renderUserBox();
    loadView('calendar');
  }).logoutUser();
}

function ensureAuth(cb){
  google.script.run.withSuccessHandler(function(user){
    if(user){ cb(); }
    else {
      M.toast({ html:'กรุณาเข้าสู่ระบบก่อนทำรายการ' });
      loadView('login');
    }
  }).getSessionUser();
}

window.addEventListener('DOMContentLoaded', renderUserBox);
</script>
