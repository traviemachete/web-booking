<script>
  let calendar; // Global calendar object

/* ---------- 1. RENDER CALENDAR ---------- */
function renderCalendar(events) {
  const calEl = document.getElementById('calendar');
  if (!calEl) return;

  // ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚áí ‡πÅ‡∏Ñ‡πà‡πÇ‡∏´‡∏•‡∏î event ‡πÉ‡∏´‡∏°‡πà
  if (calendar && events) {
    calendar.removeAllEvents();
    calendar.addEventSource(events);
    return;
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
  calendar = new FullCalendar.Calendar(calEl, {
  initialView: 'dayGridMonth',
  height: '100%', // ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ calendar ‡∏™‡∏π‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
  headerToolbar: {
    left: 'prev,next today refreshBtn',
    center: 'title',
    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
  },
  customButtons: {
    refreshBtn: {
      text: 'üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä',
      click() {
        google.script.run.withSuccessHandler(ev => renderCalendar(ev))
                         .listEvents();
      }
    }
  },
  events,
  eventClick(info) {
    const p   = info.event.extendedProps;
    const txt = `
      <b>${info.event.title}</b><br>
      ‡πÄ‡∏ß‡∏•‡∏≤: ${info.event.start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
      ‚Äì ${info.event.end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}<br>
      ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ${p.booker}<br>‡∏ù‡πà‡∏≤‡∏¢: ${p.department}<br>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: ${p.company}<br>
      ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: <i>${p.purpose}</i><br>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${p.status || '-'}
    `;
    M.toast({ html: txt, displayLength: 7000 });
  }
});
  calendar.render();
}

  // ===== FORM SUBMIT HANDLER =====
 function handleSubmit(e) {
  e.preventDefault();
  const f = e.target;
  const btn = f.querySelector('button[type="submit"]');
  btn.disabled = true;

  const data = {
    date:        f.date.value,
    start:       f.start.value,
    end:         f.end.value,
    name:        f.name.value,
    department:  f.department.value,
    company:     f.company.value,
    purpose:     f.purpose.value,
    email:       f.email.value
  };

  google.script.run
    .withSuccessHandler(() => {
      Swal.fire({
        icon: 'success',
        title: '‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
        text: '‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
      }).then(() => {
        loadView('calendar', true); // ‚úÖ refresh calendar ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á reload ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤
      });

      f.reset();
      btn.disabled = false;
    })
    .withFailureHandler(err => {
      Swal.fire({
        icon: 'error',
        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        text: err.message // ‚úÖ ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ conflict ‡∏à‡∏≤‡∏Å `throw new Error(...)`
      });
      btn.disabled = false;
    })
    .submitBooking(data); // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏£‡∏á‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö error ‡πÅ‡∏•‡πâ‡∏ß
}



  // ===== LOAD VIEW (SIDEBAR ROUTER) =====
  function loadView(view, forceRefresh = false) {
  const main = document.getElementById('mainContent');
  const map = {
    calendar: 'CalendarView',
    form: 'Form',
    login: 'Login'
  };

  google.script.run.withSuccessHandler(html => {
    main.innerHTML = html;

    if (view === 'calendar') {
      // ‡∏£‡∏≠ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô
      setTimeout(() => {
        const calEl = document.getElementById('calendar');
        if (!calEl) return;

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å server
        google.script.run.withSuccessHandler(events => {
          // ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          if (calendar) {
            calendar.destroy();
          }

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
          calendar = new FullCalendar.Calendar(calEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
              left: 'prev,next today refreshBtn',
              center: 'title',
              right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            customButtons: {
              refreshBtn: {
                text: 'üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä',
                click: () => {
                  google.script.run.withSuccessHandler(events => {
                    calendar.removeAllEvents();
                    calendar.addEventSource(events);
                  }).listEvents();
                }
              }
            },
            events,
            eventClick(info) {
              const e = info.event;
              const props = e.extendedProps;
              const html = `
                <b>${e.title}</b><br>
                ‡πÄ‡∏ß‡∏•‡∏≤: ${e.start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${e.end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}<br>
                ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ${props.booker}<br>
                ‡∏ù‡πà‡∏≤‡∏¢: ${props.department}<br>
                ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: ${props.company}<br>
                ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: <i>${props.purpose}</i><br>
                ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${props.status || '-'}
              `;
              M.toast({ html, displayLength: 7000 });
            }
          });

          calendar.render(); // ‚úÖ render ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
        }).listEvents();
      }, 100); // ‡∏£‡∏≠ DOM render ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    }

  }).include(map[view] || 'Calendar');
}

  // ===== INITIAL LOAD =====
  window.addEventListener('load', () => loadView('calendar'));

  document.addEventListener("DOMContentLoaded", () => {
  const savedTheme = localStorage.getItem("theme") || "dark";
  document.documentElement.setAttribute("data-theme", savedTheme);
  document.getElementById("themeToggle").checked = savedTheme === "light";
});

function toggleTheme() {
  const checkbox = document.getElementById("themeToggle");
  const nextTheme = checkbox.checked ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", nextTheme);
  localStorage.setItem("theme", nextTheme);
}
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const theme = localStorage.getItem("theme") || "light";
    document.documentElement.setAttribute("data-theme", theme);
    document.getElementById("themeToggle").checked = theme === "dark";
  });

  function toggleTheme() {
    const current = document.documentElement.getAttribute("data-theme");
    const next = current === "dark" ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", next);
    localStorage.setItem("theme", next);
  }
</script>
