<script>
  /* ========================================
   MEETING ROOM BOOKING SYSTEM - JavaScript
   ======================================== */

// Global variables
let calendar = null;
let currentView = 'calendar';
let isLoading = false;
let currentUser = null;
let isAuthChecked = false;

/* ========== AUTHENTICATION MANAGEMENT ========== */

function checkAuthAndRenderUserBox() {
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function(user) {
        currentUser = user;
        isAuthChecked = true;
        renderUserBox(user);
        console.log('üë§ User status:', user ? `Logged in as ${user.name}` : 'Not logged in');
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Auth check failed:', error);
        currentUser = null;
        isAuthChecked = true;
        renderUserBox(null);
      })
      .getSessionUser();
  } else {
    // Fallback for testing
    currentUser = null;
    isAuthChecked = true;
    renderUserBox(null);
    console.log('‚ö†Ô∏è Google Apps Script not available');
  }
}

function renderUserBox(user) {
  const userInfoEl = document.getElementById("userInfo");
  if (!userInfoEl) return;

  if (user) {
    userInfoEl.innerHTML = `
      <div class="user-profile">
        <div class="user-avatar">
          <span class="avatar-icon">üë§</span>
        </div>
        <div class="user-details">
          <p class="user-name">${user.name}</p>
          <p class="user-email">${user.email}</p>
        </div>
      </div>
      <button class="logout-btn" onclick="logout()">
        <span>üö™</span> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
      </button>
    `;
  } else {
    userInfoEl.innerHTML = `
      <div class="auth-prompt">
        <p class="auth-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
        <button class="login-btn" onclick="loadView('login')">
          <span>üîë</span> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
        </button>
      </div>
    `;
  }
}

function logout() {
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function() {
        currentUser = null;
        renderUserBox(null);
        
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'success',
            title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß',
            text: '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
            timer: 1500,
            showConfirmButton: false
          });
        }
        
        // Redirect to calendar
        setTimeout(() => {
          loadView('calendar');
        }, 1000);
      })
      .withFailureHandler(function(error) {
        console.error('Logout failed:', error);
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'error',
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ'
          });
        }
      })
      .logoutUser();
  } else {
    // Fallback for testing
    currentUser = null;
    renderUserBox(null);
    loadView('calendar');
  }
}

function checkAuthAndNavigate(viewName) {
  if (!isAuthChecked) {
    // Wait for auth check
    setTimeout(() => checkAuthAndNavigate(viewName), 200);
    return;
  }

  if (currentUser) {
    // User is logged in, proceed to view
    loadView(viewName);
  } else {
    // User not logged in, show login prompt
    if (typeof Swal !== 'undefined') {
      Swal.fire({
        icon: 'info',
        title: '‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°',
        showCancelButton: true,
        confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#1a73e8',
        cancelButtonColor: '#6c757d'
      }).then((result) => {
        if (result.isConfirmed) {
          loadView('login');
        }
      });
    } else {
      // Fallback without SweetAlert
      if (confirm('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°')) {
        loadView('login');
      }
    }
  }
}

/* ========== CALENDAR MANAGEMENT ========== */

function renderCalendar(events = []) {
  const calendarEl = document.getElementById('calendar');
  if (!calendarEl) {
    console.warn('Calendar element not found');
    return;
  }

  // Destroy existing calendar if it exists
  if (calendar) {
    calendar.destroy();
    calendar = null;
  }

  // Create new calendar instance
  calendar = new FullCalendar.Calendar(calendarEl, {
    // Basic configuration
    initialView: 'dayGridMonth',
    height: '100%',
    locale: 'th',
    firstDay: 0, // Sunday
    
    // Time format
    eventTimeFormat: {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    },
    
    // Header toolbar configuration
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
    },
    
    // Button text localization
    buttonText: {
      today: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
      month: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
      week: '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
      day: '‡∏ß‡∏±‡∏ô',
      list: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'
    },
    
    // Events configuration
    events: events || [],
    eventDisplay: 'block',
    dayMaxEvents: 3,
    moreLinkClick: 'popover',
    
    // Event interactions
    eventClick: function(info) {
      showEventDetails(info.event);
    },
    
    dateClick: function(info) {
      // Quick booking: check auth first
      if (!isAuthChecked) {
        setTimeout(() => calendar.getApi().trigger('dateClick', info), 200);
        return;
      }
      
      if (currentUser) {
        // Pre-fill form with selected date
        const selectedDate = info.dateStr;
        localStorage.setItem('selectedDate', selectedDate);
        loadView('form');
      } else {
        checkAuthAndNavigate('form');
      }
    },
    
    // Event styling
    eventDidMount: function(info) {
      info.el.setAttribute('title', `${info.event.title}\n‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î`);
    },
    
    // Loading states
    loading: function(isLoading) {
      toggleLoadingState(isLoading);
    },
    
    // View change handling
    datesSet: function(info) {
      currentView = info.view.type;
    }
  });

  // Render the calendar
  calendar.render();
  
  console.log(`üìÖ Calendar rendered with ${events.length} events`);
}

function showEventDetails(event) {
  const props = event.extendedProps || {};
  const startTime = event.start ? event.start.toLocaleTimeString('th-TH', {
    hour: '2-digit', 
    minute: '2-digit'
  }) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const endTime = event.end ? event.end.toLocaleTimeString('th-TH', {
    hour: '2-digit', 
    minute: '2-digit'
  }) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

  const eventDate = event.start ? event.start.toLocaleDateString('th-TH', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

  if (typeof Swal !== 'undefined') {
    Swal.fire({
      title: 'üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á',
      html: `
        <div style="text-align: left; margin: 16px 0; line-height: 1.6;">
          <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <h4 style="margin: 0 0 8px 0; color: var(--text-color);">${event.title}</h4>
            <p style="margin: 4px 0; color: var(--text-secondary);"><strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${eventDate}</p>
            <p style="margin: 4px 0; color: var(--text-secondary);"><strong>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${startTime} - ${endTime}</p>
          </div>
          <p style="margin: 8px 0;"><strong>üë§ ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</strong> ${props.booker || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
          <p style="margin: 8px 0;"><strong>üè¢ ‡∏ù‡πà‡∏≤‡∏¢:</strong> ${props.department || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
          <p style="margin: 8px 0;"><strong>üèõÔ∏è ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:</strong> ${props.company || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
          <p style="margin: 8px 0;"><strong>üéØ ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå:</strong> ${props.purpose || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
          <p style="margin: 8px 0;"><strong>üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> ${props.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
          <p style="margin: 8px 0;"><strong>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${props.status || '‡∏õ‡∏Å‡∏ï‡∏¥'}</p>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
      cancelButtonText: '‚ùå ‡∏õ‡∏¥‡∏î',
      confirmButtonColor: '#1a73e8',
      cancelButtonColor: '#6c757d',
      width: '500px'
    }).then((result) => {
      if (result.isConfirmed) {
        // TODO: Implement edit functionality
        editBooking(event.id, props);
      }
    });
  }
}

function refreshCalendarData() {
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    toggleLoadingState(true);
    
    google.script.run
      .withSuccessHandler(function(events) {
        renderCalendar(events);
        toggleLoadingState(false);
        
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'success',
            title: '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            text: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ${events.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
            timer: 1500,
            showConfirmButton: false
          });
        }
      })
      .withFailureHandler(function(error) {
        console.error('Calendar refresh failed:', error);
        toggleLoadingState(false);
        
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'error',
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'
          });
        }
      })
      .listEvents();
  }
}

/* ========== FORM MANAGEMENT ========== */

function handleSubmit(event) {
  event.preventDefault();
  
  const form = event.target;
  const submitBtn = form.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  
  // Disable submit button and show loading
  submitBtn.disabled = true;
  submitBtn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

  // Collect form data
  const formData = new FormData(form);
  const bookingData = {
    date: formData.get('date'),
    start: formData.get('start'),
    end: formData.get('end'),
    name: formData.get('name'),
    department: formData.get('department'),
    company: formData.get('company'),
    purpose: formData.get('purpose'),
    email: formData.get('email')
  };

  // Client-side validation
  if (!validateBookingData(bookingData)) {
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
    return;
  }

  // Submit to server
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function(result) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        
        if (result.status === 'ok') {
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'success',
              title: '‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ',
              text: '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
              timer: 2000,
              showConfirmButton: false
            }).then(() => {
              form.reset();
              loadView('calendar', true);
            });
          } else {
            alert('‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            form.reset();
            loadView('calendar', true);
          }
        }
      })
      .withFailureHandler(function(error) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'error',
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ'
          });
        } else {
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ'));
        }
      })
      .submitBooking(bookingData);
  } else {
    // Fallback for testing
    setTimeout(() => {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
      
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: 'info',
          title: '‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
          text: '‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script'
        });
      } else {
        alert('‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script');
      }
    }, 1000);
  }
}

function validateBookingData(data) {
  // Check required fields
  if (!data.date || !data.start || !data.end || !data.name) {
    if (typeof Swal !== 'undefined') {
      Swal.fire({
        icon: 'warning',
        title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
      });
    } else {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
    }
    return false;
  }

  // Validate time range
  if (data.start >= data.end) {
    if (typeof Swal !== 'undefined') {
      Swal.fire({
        icon: 'warning',
        title: '‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
        text: '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'
      });
    } else {
      alert('‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
    }
    return false;
  }

  // Check if booking date is in the past
  const bookingDate = new Date(data.date);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  if (bookingDate < today) {
    if (typeof Swal !== 'undefined') {
      Swal.fire({
        icon: 'warning',
        title: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ'
      });
    } else {
      alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ');
    }
    return false;
  }

  // Validate email format if provided
  if (data.email && !isValidEmail(data.email)) {
    if (typeof Swal !== 'undefined') {
      Swal.fire({
        icon: 'warning',
        title: '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
      });
    } else {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    }
    return false;
  }

  return true;
}

function isValidEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

/* ========== VIEW MANAGEMENT ========== */

function loadView(viewName, forceRefresh = false) {
  if (isLoading && !forceRefresh) return;
  
  const mainContent = document.getElementById('mainContent');
  if (!mainContent) return;

  // Update navigation active state
  setActiveNav(viewName);
  
  // Show loading state
  if (!forceRefresh) {
    mainContent.innerHTML = `
      <div class="loading-placeholder">
        <div class="loading-content">
          <div class="loading-spinner"></div>
          <h3>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h3>
          <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
        </div>
      </div>
    `;
  }
  
  // View mapping
  const viewMap = {
    calendar: 'CalendarView',
    form: 'Form',
    list: 'TodayList',
    login: 'Login',
    register: 'Register'
  };

  const templateName = viewMap[viewName] || 'CalendarView';
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    isLoading = true;
    
    google.script.run
      .withSuccessHandler(function(html) {
        mainContent.innerHTML = html;
        isLoading = false;
        
        // Post-load actions based on view
        handleViewLoaded(viewName);
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load view:', error);
        mainContent.innerHTML = `
          <div class="error-container">
            <div class="error-content">
              <h3>‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
              <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
              <button onclick="loadView('${viewName}')" class="retry-btn">
                üîÑ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
              </button>
            </div>
          </div>
        `;
        isLoading = false;
      })
      .include(templateName);
  } else {
    // Fallback content for testing
    mainContent.innerHTML = getFallbackContent(viewName);
    handleViewLoaded(viewName);
  }
}

function handleViewLoaded(viewName) {
  switch (viewName) {
    case 'calendar':
      setTimeout(() => {
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          google.script.run
            .withSuccessHandler(renderCalendar)
            .withFailureHandler(function(error) {
              console.error('Failed to load events:', error);
              renderCalendar([]); // Render empty calendar
            })
            .listEvents();
        } else {
          renderCalendar(getSampleEvents());
        }
      }, 100);
      break;
      
    case 'form':
      setupFormDefaults();
      break;
      
    case 'list':
      loadBookingList();
      break;
      
    case 'login':
    case 'register':
      // Auth views don't need special handling
      break;
  }
  
  // Sync theme toggle in header if exists
  const headerToggle = document.getElementById('themeToggleHeader');
  if (headerToggle) {
    const savedTheme = localStorage.getItem("booking-theme") || "light";
    headerToggle.checked = savedTheme === "dark";
  }
}

function setupFormDefaults() {
  // Set default date to today or selected date
  const today = new Date().toISOString().split('T')[0];
  const selectedDate = localStorage.getItem('selectedDate') || today;
  
  const dateInput = document.getElementById('date');
  if (dateInput) {
    dateInput.value = selectedDate;
    dateInput.setAttribute('min', today); // Prevent past dates
  }
  
  // Clear selected date from localStorage
  localStorage.removeItem('selectedDate');

  // Set default time range (9:00 AM - 10:00 AM)
  const startInput = document.getElementById('start');
  const endInput = document.getElementById('end');
  if (startInput && !startInput.value) {
    startInput.value = '09:00';
  }
  if (endInput && !endInput.value) {
    endInput.value = '10:00';
  }
}

function loadBookingList() {
  // TODO: Implement booking list functionality
  const listContainer = document.getElementById('booking-list');
  if (listContainer) {
    listContainer.innerHTML = `
      <div class="text-center" style="padding: 40px; color: var(--text-secondary);">
        <h3>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <p>‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤</p>
      </div>
    `;
  }
}

function setActiveNav(viewName) {
  // Remove active class from all nav items
  document.querySelectorAll('.nav-menu a').forEach(link => {
    link.classList.remove('active');
  });
  
  // Add active class to current nav item
  const activeNav = document.getElementById(`nav-${viewName}`);
  if (activeNav) {
    activeNav.classList.add('active');
  }
  
  console.log('üìç Navigation set to:', viewName);
}

/* ========== UTILITY FUNCTIONS ========== */

function toggleLoadingState(loading) {
  const calendarEl = document.getElementById('calendar');
  if (!calendarEl) return;
  
  if (loading) {
    calendarEl.style.opacity = '0.6';
    calendarEl.style.pointerEvents = 'none';
  } else {
    calendarEl.style.opacity = '1';
    calendarEl.style.pointerEvents = 'auto';
  }
}

function editBooking(eventId, eventData) {
  // TODO: Implement edit booking functionality
  if (typeof Swal !== 'undefined') {
    Swal.fire({
      icon: 'info',
      title: '‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
      text: '‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤'
    });
  } else {
    alert('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤');
  }
}

function getFallbackContent(viewName) {
  const fallbackContents = {
    calendar: `
      <div class="calendar-container">
        <div class="calendar-header">
          <h4>üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h4>
          <div class="calendar-actions">
            <button class="refresh-btn" onclick="refreshCalendarData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            <button class="add-btn" onclick="checkAuthAndNavigate('form')">‚ûï ‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
          </div>
        </div>
        <div id="calendar"></div>
      </div>
    `,
    form: `
      <div class="form-container">
        <div class="form-header">
          <h3>üìù ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h3>
          <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°</p>
        </div>
      </div>
    `,
    list: `
      <div class="text-center" style="padding: 40px; color: var(--text-secondary);">
        <h3>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>
      </div>
    `,
    login: `
      <div class="text-center" style="padding: 40px; color: var(--text-secondary);">
        <h3>üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
      </div>
    `,
    register: `
      <div class="text-center" style="padding: 40px; color: var(--text-secondary);">
        <h3>üìù ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
      </div>
    `
  };
  
  return fallbackContents[viewName] || fallbackContents.calendar;
}

function getSampleEvents() {
  const today = new Date();
  return [
    {
      id: 'sample-1',
      title: '‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ó‡∏µ‡∏° IT',
      start: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1, 9, 0),
      end: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1, 11, 0),
      backgroundColor: '#1a73e8',
      extendedProps: {
        booker: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ',
        department: '‡∏ù‡πà‡∏≤‡∏¢‡πÑ‡∏≠‡∏ó‡∏µ',
        company: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC',
        purpose: '‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
        email: 'somchai@abc.com'
      }
    },
    {
      id: 'sample-2',
      title: '‡∏≠‡∏ö‡∏£‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà',
      start: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 2, 13, 0),
      end: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 2, 16, 0),
      backgroundColor: '#34a853',
      extendedProps: {
        booker: '‡∏™‡∏∏‡∏î‡∏≤ ‡∏ô‡∏±‡∏Å‡∏≠‡∏ö‡∏£‡∏°',
        department: '‡∏ù‡πà‡∏≤‡∏¢ HR',
        company: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC',
        purpose: '‡∏≠‡∏ö‡∏£‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà',
        email: 'suda@abc.com'
      }
    }
  ];
}

/* ========== REFRESH CALENDAR ========== */

function refreshCalendar() {
  console.log('üîÑ Refreshing calendar from server...');
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    const refreshBtn = document.querySelector('.refresh-btn');
    if (refreshBtn) {
      const originalText = refreshBtn.innerHTML;
      refreshBtn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
      refreshBtn.disabled = true;
      
      google.script.run
        .withSuccessHandler(function(events) {
          if (typeof renderCalendar === 'function') {
            renderCalendar(events);
          }
          
          // Reset button
          refreshBtn.innerHTML = originalText;
          refreshBtn.disabled = false;
          
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'success',
              title: '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
              text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß',
              timer: 1500,
              showConfirmButton: false
            });
          }
          
          console.log('‚úÖ Calendar refreshed successfully');
        })
        .withFailureHandler(function(error) {
          console.error('‚ùå Failed to refresh calendar:', error);
          
          // Reset button
          refreshBtn.innerHTML = originalText;
          refreshBtn.disabled = false;
          
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'error',
              title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
              text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
            });
          }
        })
        .listEvents();
    }
  } else {
    console.error('‚ùå Google Apps Script not available');
  }
}

/* ========== INITIALIZATION ========== */

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ Meeting Room Booking System - JavaScript loaded');
  
  // Set up global error handling
  window.addEventListener('error', function(e) {
    console.error('üí• Global error:', e.error);
  });
  
  // Initialize theme
  const savedTheme = localStorage.getItem("booking-theme") || "light";
  document.documentElement.setAttribute("data-theme", savedTheme);
  
  // Check authentication
  checkAuthAndRenderUserBox();
});

// Export functions for global access
window.renderCalendar = renderCalendar;
window.handleSubmit = handleSubmit;
window.loadView = loadView;
window.refreshCalendarData = refreshCalendarData;
window.refreshCalendar = refreshCalendar;
window.checkAuthAndNavigate = checkAuthAndNavigate;
window.renderUserBox = renderUserBox;
window.logout = logout;
window.currentUser = currentUser;
window.isAuthChecked = isAuthChecked;
</script>
