<script>
  let calendar; // Global calendar object

  // ===== RENDER CALENDAR =====
  function renderCalendar(events) {
    const calEl = document.getElementById('calendar');
    if (!calEl) return;

    if (calendar) {
      calendar.removeAllEvents();
      calendar.addEventSource(events);
      return; // ‚úÖ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    }

    calendar = new FullCalendar.Calendar(calEl, {
      initialView: 'dayGridMonth',
      headerToolbar: {
        left: 'prev,next today refreshBtn',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
      },
      customButtons: {
        refreshBtn: {
          text: 'üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä',
          click: () => {
            google.script.run.withSuccessHandler(events => {
              calendar.removeAllEvents();
              calendar.addEventSource(events);
            }).listEvents();
          }
        }
      },
      events,
      eventClick(info) {
        const e = info.event;
        const props = e.extendedProps;
        const html = `
          <b>${e.title}</b><br>
          ‡πÄ‡∏ß‡∏•‡∏≤: ${e.start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${e.end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}<br>
          ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ${props.booker}<br>
          ‡∏ù‡πà‡∏≤‡∏¢: ${props.department}<br>
          ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: ${props.company}<br>
          ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: <i>${props.purpose}</i><br>
          ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${props.status || '-'}
        `;
        M.toast({ html, displayLength: 7000 });
      }
    });

    calendar.render();
  }

  // ===== FORM SUBMIT HANDLER =====
 function handleSubmit(e) {
  e.preventDefault();
  const f = e.target;
  const btn = f.querySelector('button[type="submit"]');
  btn.disabled = true;

  const data = {
    date:        f.date.value,
    start:       f.start.value,
    end:         f.end.value,
    name:        f.name.value,
    department:  f.department.value,
    company:     f.company.value,
    purpose:     f.purpose.value,
    email:       f.email.value
  };

  google.script.run
    .withSuccessHandler(() => {
      Swal.fire({
        icon: 'success',
        title: '‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
        text: '‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
      }).then(() => {
        loadView('calendar', true); // ‚úÖ refresh calendar ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á reload ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤
      });

      f.reset();
      btn.disabled = false;
    })
    .withFailureHandler(err => {
      Swal.fire({
        icon: 'error',
        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        text: err.message // ‚úÖ ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ conflict ‡∏à‡∏≤‡∏Å `throw new Error(...)`
      });
      btn.disabled = false;
    })
    .submitBooking(data); // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏£‡∏á‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö error ‡πÅ‡∏•‡πâ‡∏ß
}



  // ===== LOAD VIEW (SIDEBAR ROUTER) =====
  function loadView(view, forceRefresh = false) {
  const main = document.getElementById('mainContent');
  const map = {
    calendar: 'CalendarView',
    form: 'Form',
    login: 'Login'
  };

  google.script.run.withSuccessHandler(html => {
    main.innerHTML = html;

    if (view === 'calendar') {
      // ‡∏£‡∏≠ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô
      setTimeout(() => {
        const calEl = document.getElementById('calendar');
        if (!calEl) return;

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å server
        google.script.run.withSuccessHandler(events => {
          // ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          if (calendar) {
            calendar.destroy();
          }

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
          calendar = new FullCalendar.Calendar(calEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
              left: 'prev,next today refreshBtn',
              center: 'title',
              right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            customButtons: {
              refreshBtn: {
                text: 'üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä',
                click: () => {
                  google.script.run.withSuccessHandler(events => {
                    calendar.removeAllEvents();
                    calendar.addEventSource(events);
                  }).listEvents();
                }
              }
            },
            events,
            eventClick(info) {
              const e = info.event;
              const props = e.extendedProps;
              const html = `
                <b>${e.title}</b><br>
                ‡πÄ‡∏ß‡∏•‡∏≤: ${e.start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${e.end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}<br>
                ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ${props.booker}<br>
                ‡∏ù‡πà‡∏≤‡∏¢: ${props.department}<br>
                ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: ${props.company}<br>
                ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: <i>${props.purpose}</i><br>
                ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${props.status || '-'}
              `;
              M.toast({ html, displayLength: 7000 });
            }
          });

          calendar.render(); // ‚úÖ render ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
        }).listEvents();
      }, 100); // ‡∏£‡∏≠ DOM render ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    }

  }).include(map[view] || 'Calendar');
}

  // ===== INITIAL LOAD =====
  window.addEventListener('load', () => loadView('calendar'));
</script>
